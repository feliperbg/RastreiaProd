<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Adicionar Produto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 500px;
            margin-top: 50px;
        }
        .form-label {
            font-weight: 600;
            color: #495057;
        }
        .form-control, .form-select {
            border-radius: 5px;
            box-shadow: none;
            padding: 0.8rem 1rem;
        }
        .form-control:focus, .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.25rem rgba(38, 143, 255, 0.25);
        }
        .btn-primary {
            border-radius: 5px;
            padding: 0.6rem 1.5rem;
            font-weight: bold;
        }
            .btn-secondary {
            background-color: #ff0000;
            border-color: #ff0000b9;
            border-radius: 5px;
            padding: 0.6rem 1.5rem;
            font-weight: bold;
        }
        .btn-secondary:hover {
            background-color: #ff0000;
            border-color: #ff0000b9;
        }
        .mb-3 {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="p-3">
    <div class="container">
        <h1>Adicionar Novo Produto</h1>

        <form id="form-adicionar">
            <div class="mb-3">
                <label for="nome" class="form-label">Nome</label>
                <input type="text" id="nome" name="nome" class="form-control" required />
            </div>

            <div class="mb-3">
                <label for="codigo" class="form-label">Código</label>
                <input type="text" id="codigo" name="codigo" class="form-control" required />
            </div>

            <div class="mb-3">
                <label for="descricao" class="form-label">Descrição</label>
                <textarea type="text" id="descricao" name="descricao" class="form-control" rows="3"></textarea>
            </div>

            <div class="mb-3">
                <label class="form-label">Componentes Necessários</label>
                <div class="input-group">
                    <input type="text" id="componentesNecessarios" name="componentesNecessarios" class="form-control" placeholder="Nenhum componente selecionado" readonly />
                    <button type="button" class="btn btn-outline-secondary" id="btnSelecionarComponentes">Selecionar</button>
                </div>
            </div>

            <div class="mb-3">
                <label for="dataEntrada" class="form-label">Data de Entrada</label>
                <input type="date" id="dataEntrada" name="dataEntrada" class="form-control" />
            </div>

            <div class="mb-3">
                <label for="dataValidade" class="form-label">Data de Validade</label>
                <input type="date" id="dataValidade" name="dataValidade" class="form-control" />
            </div>

            <div class="mb-3">
                <label for="precoMontagem" class="form-label">Preço de Montagem</label>
                <input type="text" id="precoMontagem" name="precoMontagem" class="form-control" />
            </div>

            <div class="mb-3">
                <label for="precoVenda" class="form-label">Preço de Venda</label>
                <input type="text" id="precoVenda" name="precoVenda" class="form-control" />
            </div>

            <div class="mb-3">
                <label for="quantidade" class="form-label">Quantidade em Estoque</label>
                <input type="number" id="quantidade" name="quantidade" class="form-control" />
            </div>

            <div class="mb-3">
                <label class="form-label">Etapas de Montagem</label>
                <div class="input-group">
                    <input type="text" id="etapas" name="etapas" class="form-control" placeholder="Nenhuma etapa selecionada" readonly />
                    <button type="button" class="btn btn-outline-secondary" id="btnSelecionarEtapas">Selecionar</button>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">Adicionar Produto</button>
            <button type="button" class="btn btn-secondary" onclick="window.location.href='/produto'">Cancelar</button>
        </form>
    </div>
    
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="meuToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div id="toast-body" class="toast-body"></div>
                <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/toast.js"></script> <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {

          // --- ESTRUTURA DE DADOS ---
          // Começa com tudo vazio, pois é um novo produto
          let componentesSelecionados = []; // Formato: [{ componente: 'id', quantidade: 1 }]
          let etapasSelecionadasIds = [];
          let listaCompletaComponentes = [];
          let listaCompletaEtapas = [];

          // --- FUNÇÕES AUXILIARES ---

          /**
           * Atualiza o campo de input visual dos componentes.
           */
          function atualizarDisplayComponentes() {
              const input = document.getElementById('componentesNecessarios');
              if (componentesSelecionados.length === 0) {
                  input.value = '';
                  return;
              }
              const nomes = componentesSelecionados.map(sel => {
                  const comp = listaCompletaComponentes.find(c => c._id === sel.componente);
                  return `${comp ? comp.nome : 'Desconhecido'} (Qtd: ${sel.quantidade})`;
              });
              input.value = nomes.join(', ');
          }

          /**
           * Carrega as listas completas de componentes e etapas sob demanda (lazy loading).
           */
          async function carregarListasCompletas() {
              try {
                  // Só carrega se a lista ainda estiver vazia
                  if (listaCompletaComponentes.length > 0 && listaCompletaEtapas.length > 0) return;

                  const [compRes, etapasRes] = await Promise.all([
                      fetch('/componente/readALL', { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } }),
                      fetch('/etapa/readALL', { headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` } })
                  ]);
                  const compJson = await compRes.json();
                  const etapasJson = await etapasRes.json();
                  listaCompletaComponentes = compJson.componentes || [];
                  listaCompletaEtapas = etapasJson.etapas || [];
              } catch (error) {
                  console.error("Erro ao carregar listas completas:", error);
                  exibirMensagem("Não foi possível carregar as opções de seleção.", "erro");
              }
          }

          // --- EVENT LISTENERS PARA OS BOTÕES DE SELEÇÃO ---

          document.getElementById('btnSelecionarComponentes').addEventListener('click', async function () {
              await carregarListasCompletas();
              const idsAtuais = componentesSelecionados.map(c => c.componente);
              const selecaoResult = await selecionarMultiplos('Selecionar Componentes', listaCompletaComponentes, idsAtuais);

              if (selecaoResult.isConfirmed) {
                  const novosIdsSelecionados = selecaoResult.value;
                  const novosComponentesInfo = [];
                  let processoCancelado = false;

                  for (const id of novosIdsSelecionados) {
                      const componente = listaCompletaComponentes.find(c => c._id === id);
                      if (!componente) continue;

                      const componenteExistente = componentesSelecionados.find(c => c.componente === id);
                      const quantidadeSugerida = componenteExistente ? componenteExistente.quantidade : 1;

                      const quantidadeResult = await Swal.fire({
                          title: `Quantidade para ${componente.nome}`,
                          input: 'number',
                          inputValue: quantidadeSugerida,
                          inputAttributes: { min: 1 },
                          showCancelButton: true,
                          confirmButtonText: 'Próximo &rarr;',
                          cancelButtonText: 'Cancelar processo',
                          inputValidator: (value) => !value || parseInt(value, 10) < 1 ? 'Insira uma quantidade válida (mínimo 1)' : null
                      });

                      if (quantidadeResult.isConfirmed && quantidadeResult.value) {
                          novosComponentesInfo.push({
                              componente: id,
                              quantidade: parseInt(quantidadeResult.value, 10)
                          });
                      } else {
                          processoCancelado = true;
                          break;
                      }
                  }

                  if (!processoCancelado) {
                      componentesSelecionados = novosComponentesInfo;
                      atualizarDisplayComponentes();
                      exibirMensagem('Componentes atualizados!', 'sucesso');
                  }
              }
          });

          document.getElementById('btnSelecionarEtapas').addEventListener('click', async function () {
              await carregarListasCompletas();
              const result = await selecionarMultiplos('Selecionar Etapas', listaCompletaEtapas, etapasSelecionadasIds);

              if (result.isConfirmed) {
                  etapasSelecionadasIds = result.value;
                  const nomesSelecionados = listaCompletaEtapas
                      .filter(item => etapasSelecionadasIds.includes(item._id))
                      .map(item => item.nome);
                  document.getElementById('etapas').value = nomesSelecionados.join(', ');
              }
          });

          // --- FUNÇÃO DE SUBMIT ---

          /**
           * MUDANÇA: Função para ADICIONAR um novo produto.
           * Envia os dados via POST.
           */
          async function adicionarProduto(event) {
              event.preventDefault();
              
              const dadosNovoProduto = {
                  nome: document.getElementById('nome').value,
                  codigo: document.getElementById('codigo').value,
                  descricao: document.getElementById('descricao').value,
                  componentesNecessarios: componentesSelecionados,
                  dataEntrada: document.getElementById('dataEntrada').value,
                  dataValidade: document.getElementById('dataValidade').value,
                  precoMontagem: parseFloat(document.getElementById('precoMontagem').value),
                  precoVenda: parseFloat(document.getElementById('precoVenda').value),
                  quantidade: parseInt(document.getElementById('quantidade').value),
                  etapas: etapasSelecionadasIds,
              };

              // Adicione aqui suas validações se necessário

              try {
                  const response = await fetch('/produto', {
                      method: 'POST', 
                      headers: {
                          'Content-Type': 'application/json',
                          'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                      },
                      body: JSON.stringify(dadosNovoProduto)
                  });

                  const result = await response.json();
                  if (!response.ok) throw new Error(result.msg || "Erro ao criar o produto.");
                  
                  await Swal.fire('Sucesso!', 'Produto adicionado com sucesso.', 'success');
                  window.location.href = '/produto'; // Redireciona para a lista de produtos

              } catch (error) {
                  exibirMensagem(error.message, 'erro');
              }
          }

          // MUDANÇA: Adiciona o listener ao formulário de adicionar
          document.getElementById('form-adicionar').addEventListener('submit', adicionarProduto);

          // --- FUNÇÕES GENÉRICAS (sem alterações) ---

          // Função para o modal de seleção (SweetAlert2)
          async function selecionarMultiplos(titulo, lista, selecionados) {
              // ... sua função selecionarMultiplos continua aqui, sem alterações ...
              return Swal.fire({
                  title: titulo,
                  html: `
                      <input type="text" id="swal-filtro" class="form-control mb-2" placeholder="Filtrar...">
                      <div id="swal-lista" style="max-height:300px;overflow:auto;text-align:left">
                          ${lista.map(item => `
                              <div>
                                  <input type="checkbox" id="swal-${item._id}" value="${item._id}" ${selecionados.includes(item._id) ? 'checked' : ''}>
                                  <label for="swal-${item._id}">${item.nome}</label>
                              </div>
                          `).join('')}
                      </div>`,
                  showCancelButton: true,
                  confirmButtonText: 'Selecionar',
                  cancelButtonText: 'Cancelar',
                  preConfirm: () => Array.from(document.querySelectorAll('#swal-lista input[type=checkbox]:checked')).map(cb => cb.value),
                  didOpen: () => {
                      document.getElementById('swal-filtro').addEventListener('input', function() {
                          const val = this.value.toLowerCase();
                          document.querySelectorAll('#swal-lista label').forEach(label => {
                              label.parentElement.style.display = label.textContent.toLowerCase().includes(val) ? '' : 'none';
                          });
                      });
                  }
              });
          }

          /**
           * BÔNUS: Define a data de entrada como a data de hoje para conveniência.
           */
          function setDataDeHoje() {
              const hoje = new Date().toISOString().substring(0, 10);
              document.getElementById('dataEntrada').value = hoje;
          }

          setDataDeHoje();
      });
    </script>
</body>
</html>