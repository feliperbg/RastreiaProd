<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Adicionar Funcionário</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@17.0.15/build/js/intlTelInput.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/inputmask@5.0.6/dist/inputmask.min.js"></script>
</head>
<body class="p-3">
    <div class="container">
        <h1>Adicionar Funcionário</h1>

        <form id="form-adicionar">
            <div class="mb-3">
                <label for="nome" class="form-label">Nome</label>
                <input type="text" id="nome" name="nome" class="form-control" required autocomplete="name">
            </div>

            <div class="mb-3">
                <label for="turno" class="form-label">Turno</label>
                <select id="turno" name="turno" class="form-select" required>
                    <option value="">Selecione o turno</option>
                    <option value="Manhã">Manhã</option>
                    <option value="Tarde">Tarde</option>
                    <option value="Noite">Noite</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="senha" class="form-label">Senha</label>
                <input type="password" id="senha" name="senha" class="form-control" required autocomplete="new-password">
            </div>

            <div class="mb-3">
                <label for="CPF" class="form-label">CPF</label>
                <input type="text" id="CPF" name="CPF" class="form-control" placeholder="000.000.000-00" required autocomplete="off">
            </div>

            <div class="mb-3">
                <label for="email" class="form-label">E-mail</label>
                <input type="email" id="email" name="email" class="form-control" required autocomplete="email">
            </div>

            <div class="mb-3">
                <label for="telefone" class="form-label">Telefone</label>
                <input type="tel" id="telefone" name="telefone" class="form-control" placeholder="(XX) XXXXX-XXXX" autocomplete="tel">
            </div>

            <div class="mb-3">
                <label for="dataNascimento" class="form-label">Data de Nascimento</label>
                <input type="date" id="dataNascimento" name="dataNascimento" class="form-control" autocomplete="bday">
            </div>

            <div class="mb-3">
                <label class="form-label">Permissões</label>
                <fieldset class="border p-3 rounded">
                    <legend class="float-none w-auto p-0">Selecione as permissões:</legend>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="permissoes" id="perm_admin" value="administrador">
                        <label class="form-check-label" for="perm_admin">Administrador</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="permissoes" id="perm_editar" value="editar_conteudos">
                        <label class="form-check-label" for="perm_editar">Editar Conteúdos</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="permissoes" id="perm_excluir" value="excluir_conteudos">
                        <label class="form-check-label" for="perm_excluir">Excluir Conteúdos</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="permissoes" id="perm_gerenciar_usuarios" value="gerenciar_usuarios">
                        <label class="form-check-label" for="perm_gerenciar_usuarios">Gerenciar Usuários</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="permissoes" id="perm_gerar_relatorios" value="gerar_relatorios">
                        <label class="form-check-label" for="perm_gerar_relatorios">Gerar Relatórios</label>
                    </div>
                </fieldset>
            </div>

            <div class="mb-3">
                <label for="role" class="form-label">Nível de Acesso</label>
                <select id="role" name="role" class="form-select">
                    <option value="">Selecione o nível</option>
                    <option value="funcionario">Funcionário</option>
                    <option value="administrador">Administrador</option>>
                </select>
            </div>

            <button type="submit" class="btn btn-primary">Adicionar Funcionário</button>
        </form>
    </div>

    <script>
        const cpfInput = document.getElementById('CPF');
        const telefoneInput = document.getElementById('telefone');
        const formAdicionar = document.getElementById('form-adicionar');
        const nomeInput = document.getElementById('nome');
        const emailInput = document.getElementById('email');
        const senhaInput = document.getElementById('senha');
        const turnoSelect = document.getElementById('turno');
        const dataNascimentoInput = document.getElementById('dataNascimento');
        const roleSelect = document.getElementById('role');

        Inputmask('999.999.999-99').mask(cpfInput);
        Inputmask('(99) 99999-9999').mask(telefoneInput);

        formAdicionar.addEventListener('submit', async function (event) {
            event.preventDefault();

            if (!validarCampos()) {
                return;
            }

            const permissoes = Array.from(document.querySelectorAll('input[name="permissoes"]:checked')).map(cb => cb.value);

            const dados = {
                nome: nomeInput.value,
                turno: turnoSelect.value,
                senha: senhaInput.value,
                CPF: cpfInput.value,
                email: emailInput.value,
                telefone: telefoneInput.value,
                dataNascimento: dataNascimentoInput.value,
                permissoes: permissoes,
                role: roleSelect.value
            };

            try {
                const response = await fetch('/funcionario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });

                const resultado = await response.json();

                if (response.ok && resultado.funcionario) {
                    Swal.fire({
                        title: 'Funcionário Criado!',
                        html: `Credencial: <b>${resultado.funcionario.credencial}</b><br>ID: <b>${resultado.funcionario.id}</b>`,
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        window.location.href = '/funcionario';
                    });
                } else {
                    Swal.fire('Erro', resultado.message || 'Erro ao criar funcionário.', 'error');
                }
            } catch (error) {
                console.error('Erro:', error);
                Swal.fire('Erro', 'Erro de conexão com o servidor.', 'error');
            }
        });

        function validarCampos() {
            if (!nomeInput.value.trim()) {
                Swal.fire('Atenção', 'O nome é obrigatório.', 'warning');
                nomeInput.focus();
                return false;
            }

            if (!turnoSelect.value) {
                Swal.fire('Atenção', 'Selecione o turno.', 'warning');
                turnoSelect.focus();
                return false;
            }

            if (!senhaInput.value) {
                Swal.fire('Atenção', 'A senha é obrigatória.', 'warning');
                senhaInput.focus();
                return false;
            }

            if (!cpfInput.value) {
                Swal.fire('Atenção', 'O CPF é obrigatório.', 'warning');
                cpfInput.focus();
                return false;
            } else if (!validarCPF(cpfInput.value)) {
                Swal.fire('Atenção', 'CPF inválido.', 'warning');
                cpfInput.focus();
                return false;
            }

            if (!emailInput.value) {
                Swal.fire('Atenção', 'O e-mail é obrigatório.', 'warning');
                emailInput.focus();
                return false;
            } else if (!isValidEmail(emailInput.value)) {
                Swal.fire('Atenção', 'E-mail inválido.', 'warning');
                emailInput.focus();
                return false;
            }

            if (telefoneInput.value && !Inputmask.isValid(telefoneInput.value, '(99) 99999-9999')) {
                Swal.fire('Atenção', 'Número de telefone inválido.', 'warning');
                telefoneInput.focus();
                return false;
            }

            return true;
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function validarCPF(cpf) {
            cpf = cpf.replace(/\D/g, '');
            if (cpf.length !== 11 ||
                cpf === '00000000000' ||
                cpf === '11111111111' ||
                cpf === '22222222222' ||
                cpf === '33333333333' ||
                cpf === '44444444444' ||
                cpf === '55555555555' ||
                cpf === '66666666666' ||
                cpf === '77777777777' ||
                cpf === '88888888888' ||
                cpf === '99999999999') {
                return false;
            }
            let soma = 0;
            for (let i = 0; i < 9; i++) {
                soma += parseInt(cpf.charAt(i)) * (10 - i);
            }
            let resto = 11 - (soma % 11);
            if (resto === 10 || resto === 11) {
                resto = 0;
            }
            if (resto !== parseInt(cpf.charAt(9))) {
                return false;
            }
            soma = 0;
            for (let i = 0; i < 10; i++) {
                soma += parseInt(cpf.charAt(i)) * (11 - i);
            }
            resto = 11 - (soma % 11);
            if (resto === 10 || resto === 11) {
                resto = 0;
            }
            if (resto !== parseInt(cpf.charAt(10))) {
                return false;
            }
            return true;
        }
    </script>
</body>
</html>