<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>Lista de Funcionários</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Ícones Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>

<body>
  <div class="container py-4">
    <h2 class="mb-4">Funcionários</h2>

    <!-- Campo de Filtro -->
    <div class="mb-3">
      <input type="text" id="filtro" class="form-control" placeholder="Filtrar por nome, turno, CPF ou email..." />
    </div>

    <!-- Tabela -->
    <div class="table-responsive">
      <table class="table table-hover table-bordered align-middle">
        <thead class="table-dark">
          <tr>
            <th>Nome</th>
            <th>Turno</th>
            <th>CPF</th>
            <th>Email</th>
            <th>Telefone</th>
            <th>Credencial</th>
            <th>Data de Nascimento</th>
            <th>Permissões</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="tabela-funcionarios">
          <!-- Os dados serão carregados dinamicamente aqui -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Script de filtro e carregamento de dados -->
  <script>
    // Função para formatar a data no formato dd/mm/yyyy
    function formatarData(data) {
      if (!data) return '';
      const date = new Date(data);
      return date.toLocaleDateString('pt-BR');
    }

    // Função para formatar o CPF
    function formatarCPF(cpf) {
      if (!cpf) return '';
      return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    }

    // Função para formatar o telefone
    function formatarTelefone(telefone) {
      if (!telefone) return '';
      // Formato (XX) XXXXX-XXXX
      return telefone.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    }

    async function carregarTabela() {
      try {
        const response = await fetch('/funcionario/readALL', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('dados.token')}` // Se precisar de autenticação
          },
        });

        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }

        const funcionarios = await response.json();
        console.log(funcionarios);

        const tbody = document.getElementById("tabela-funcionarios");
        tbody.innerHTML = "";

        funcionarios.forEach(func => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${func.nome}</td>
            <td>${func.turno}</td>
            <td>${formatarCPF(func.CPF)}</td>
            <td>${func.email}</td>
            <td>${formatarTelefone(func.telefone)}</td>
            <td>${func.credencial}</td>
            <td>${formatarData(func.dataNascimento)}</td>
            <td>${func.permissoes.join(', ')}</td>
            <td>
              <button class="btn btn-sm btn-primary me-1" onclick="editarFuncionario('${func._id}')">
                <i class="bi bi-pencil"></i> Editar
              </button>
              <button class="btn btn-sm btn-danger" onclick="deletarFuncionario('${func._id}')">
                <i class="bi bi-trash"></i> Deletar
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        if (!data.status) { // Se sua API retorna um status booleano
          throw new Error(data.msg || 'Erro na resposta da API');
        }
      } catch (error) {
        console.error('Falha ao buscar funcionários:', error);
        // Aqui você pode tratar diferentes tipos de erro:
        if (error.message.includes('401')) {
          // Token expirado/inválido - redirecionar para login
          window.location.href = '/login';
        }
        throw error; // Rejeita a promise para tratamento posterior
      }
    }

    function editarFuncionario(id) {
      alert("Editar funcionário com ID: " + id);
      // Aqui você pode abrir um modal ou redirecionar para a página de edição
      // window.location.href = `/editar-funcionario?id=${id}`;
    }

    async function deletarFuncionario(id) {
      const confirmacao = confirm("Tem certeza que deseja excluir este funcionário?");
      if (confirmacao) {
        try {
          // Substitua esta URL pela sua API real
          const response = await fetch(`http://sua-api/funcionarios/${id}`, {
            method: 'DELETE'
          });

          if (response.ok) {
            alert("Funcionário excluído com sucesso!");
            carregarTabela(); // Recarrega a tabela após exclusão
          } else {
            throw new Error("Falha ao excluir funcionário");
          }
        } catch (error) {
          console.error("Erro ao excluir funcionário:", error);
          alert("Erro ao excluir funcionário");
        }
      }
    }

    // Filtro de busca
    document.getElementById("filtro").addEventListener("input", function () {
      const termo = this.value.toLowerCase();
      const linhas = document.querySelectorAll("#tabela-funcionarios tr");

      linhas.forEach(tr => {
        const texto = tr.innerText.toLowerCase();
        tr.style.display = texto.includes(termo) ? "" : "none";
      });
    });

    // Carrega os dados quando a página é carregada
    document.addEventListener('DOMContentLoaded', carregarTabela);
  </script>
</body>

</html>